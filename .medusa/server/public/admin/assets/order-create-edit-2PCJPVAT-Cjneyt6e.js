import{M as U}from"./chunk-NNBHHXXN-De3in0dB.js";import{b as H,u as L,c as B,d as D,e as Q,f as V,g as $}from"./chunk-5CCKT6WV-DKcvavu1.js";import{D as G}from"./chunk-7I5DQGWY-CwOWioty.js";import{a as S}from"./chunk-PDWBYQOW-Dmlh1vBq.js";import{P as J,a as K}from"./chunk-IQBAUTU5-DhxzVBbl.js";import{$ as X,u as Y,b as v,b6 as Z,b7 as W,r as g,j as e,t as p,aj as ee,ak as se,g as te,H as z,x as h,I as q,am as ae,B as I,an as A,da as re,aQ as ne,N as k,a6 as T,A as ie,db as le,bd as de,aw as ce,f as oe,M as R}from"./index-BgVe_0kv.js";import{u as ue,_ as me}from"./chunk-B2JT2FOA-BSXwNWRq.js";import"./chunk-GJUPECDU-B_gdUAWI.js";import{u as xe}from"./chunk-C76H5USB-DrtEOpci.js";import{K as fe}from"./chunk-6HTZNHPT-DYv5rdOA.js";import{R as b,u as pe,a as he,S as _}from"./chunk-4TC5YS65-DXocPEx1.js";import"./chunk-P3UUX2T6-lsga-MMc.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-YEDAFXMB-obgKcW-e.js";import"./chunk-M3VFKDXJ-5b2kUcOC.js";import"./chunk-AOFGTNG6-BeWYmYwG.js";import"./descending-sorting-DUzSPM8R.js";import"./chunk-EMIHDNB7-ChnLsj58.js";import"./chunk-PFKKVLZX-BUhfDJBx.js";import"./_isIndex-Bg1JWU9r.js";import"./date-picker-B1D_H6c6.js";import"./clsx-B-dksMZM.js";import"./triangle-left-mini-TbLyUVtl.js";var C=oe(),je=s=>{const{t:l}=v();return g.useMemo(()=>[C.display({id:"select",header:({table:t})=>e.jsx(R,{checked:t.getIsSomePageRowsSelected()?"indeterminate":t.getIsAllPageRowsSelected(),onCheckedChange:r=>t.toggleAllPageRowsSelected(!!r)}),cell:({row:t})=>{const r=t.getCanSelect();return e.jsx(R,{disabled:!r,checked:t.getIsSelected(),onCheckedChange:a=>t.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),C.display({id:"product",header:()=>e.jsx(K,{}),cell:({row:t})=>e.jsx(J,{product:t.original.product})}),C.accessor("sku",{header:l("fields.sku"),cell:({getValue:t})=>t()||"-"}),C.accessor("title",{header:l("fields.title")})],[l,s])},ge=()=>{const{t:s}=v();return[{key:"created_at",label:s("fields.createdAt"),type:"date"},{key:"updated_at",label:s("fields.updatedAt"),type:"date"}]},ye=({pageSize:s=50,prefix:l})=>{const t=xe(["q","offset","order","created_at","updated_at"],l),{offset:r,created_at:a,updated_at:u,...m}=t;return{searchParams:{...m,limit:s,offset:r?Number(r):0,created_at:a?JSON.parse(a):void 0,updated_at:u?JSON.parse(u):void 0},raw:t}},O=50,M="rit",be=({onSelectionChange:s,currencyCode:l})=>{const{t}=v(),[r,a]=g.useState({}),u=c=>{const N=typeof c=="function"?c(r):c;a(N),s(Object.keys(N))},{searchParams:m,raw:x}=ye({pageSize:O,prefix:M}),{variants:y=[],count:f}=re({...m,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),n=je(l),w=ge(),{table:j}=ue({data:y,columns:n,count:f,enablePagination:!0,getRowId:c=>c.id,pageSize:O,enableRowSelection:c=>!0,rowSelection:{state:r,updater:u}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(me,{table:j,columns:n,pageSize:O,count:f,filters:w,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:t("fields.product")},{key:"title",label:t("fields.title")},{key:"sku",label:t("fields.sku")}],prefix:M,queryObject:x})})};function ve({item:s,currencyCode:l,orderId:t}){const{t:r}=v(),{mutateAsync:a}=D(t),{mutateAsync:u}=Q(t),{mutateAsync:m}=V(t),{mutateAsync:x}=$(t),y=g.useMemo(()=>{var i;return!!((i=s.actions)!=null&&i.find(d=>d.action==="ITEM_ADD"))},[s]),f=g.useMemo(()=>{var i;return!!((i=s.actions)!=null&&i.find(d=>d.action==="ITEM_UPDATE"))},[s]),n=g.useMemo(()=>{var d;return!!((d=s.actions)==null?void 0:d.find(o=>o.action==="ITEM_UPDATE"))&&s.quantity===s.detail.fulfilled_quantity},[s]),w=async i=>{var o;if(i<=s.detail.fulfilled_quantity){p.error(r("orders.edits.validation.quantityLowerThanFulfillment"));return}if(i===s.quantity)return;const d=(o=s.actions)==null?void 0:o.find(E=>E.action==="ITEM_ADD");try{d?await u({quantity:i,actionId:d.id}):await m({quantity:i,itemId:s.id})}catch(E){p.error(E.message)}},j=async()=>{var d;const i=(d=s.actions)==null?void 0:d.find(o=>o.action==="ITEM_ADD");try{i?await x(i.id):await m({quantity:s.detail.fulfilled_quantity,itemId:s.id})}catch(o){p.error(o.message)}},c=async()=>{var d;const i=(d=s.actions)==null?void 0:d.find(o=>o.action==="ITEM_UPDATE");try{i&&await x(i.id)}catch(o){p.error(o.message)}},N=async()=>{try{await a({items:[{variant_id:s.variant_id,quantity:s.quantity}]})}catch(i){p.error(i.message)}};return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center justify-between",children:[e.jsxs("div",{className:"flex flex-row items-center gap-x-3",children:[e.jsx(ne,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(k,{className:"txt-small",as:"span",weight:"plus",children:[s.title," "]}),s.variant_sku&&e.jsxs("span",{children:["(",s.variant_sku,")"]})]}),e.jsx(k,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.subtitle})]})]}),y&&e.jsx(T,{size:"2xsmall",rounded:"full",color:"blue",className:"mr-1",children:r("general.new")}),n?e.jsx(T,{size:"2xsmall",rounded:"full",color:"red",className:"mr-1",children:r("general.removed")}):f&&e.jsx(T,{size:"2xsmall",rounded:"full",color:"orange",className:"mr-1",children:r("general.modified")})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(q,{className:"bg-ui-bg-base txt-small w-[67px] rounded-lg [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",disabled:s.detail.fulfilled_quantity===s.quantity,min:s.detail.fulfilled_quantity,defaultValue:s.quantity,onBlur:i=>{const d=i.target.value,o=d===""?null:Number(d);o&&w(o)}}),e.jsx(k,{className:"txt-small text-ui-fg-subtle",children:r("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(U,{currencyCode:l,amount:s.total})}),e.jsx(ie,{groups:[{actions:[{label:r("actions.duplicate"),onClick:N,icon:e.jsx(le,{})}]},{actions:[n?{label:r("actions.undo"),onClick:c,icon:e.jsx(ce,{})}:{label:r("actions.remove"),onClick:j,icon:e.jsx(de,{}),disabled:s.detail.fulfilled_quantity===s.quantity}].filter(Boolean)}]})]})]})},s.quantity)}var F=[],Ne=({order:s,preview:l})=>{const{t}=v(),{setIsOpen:r}=he(),[a,u]=g.useState(""),{mutateAsync:m,isPending:x}=D(s.id),y=async()=>{await m({items:F.map(n=>({variant_id:n,quantity:1}))},{onError:n=>{p.error(n.message)}}),r("inbound-items",!1)},f=g.useMemo(()=>l.items.filter(n=>n.title.toLowerCase().includes(a)||n.product_title.toLowerCase().includes(a)),[l,a]);return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-3 mt-8 flex items-center justify-between",children:[e.jsx(z,{level:"h2",children:t("fields.items")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{value:a,onChange:n=>u(n.target.value),placeholder:t("fields.search"),autoComplete:"off",type:"search"}),e.jsxs(_,{id:"inbound-items",children:[e.jsx(_.Trigger,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:t("actions.addItems")})}),e.jsxs(_.Content,{children:[e.jsx(_.Header,{}),e.jsx(be,{currencyCode:s.currency_code,onSelectionChange:n=>{F=n}}),e.jsx(_.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(b.Close,{asChild:!0,children:e.jsx(I,{type:"button",variant:"secondary",size:"small",children:t("actions.cancel")})}),e.jsx(I,{type:"submit",variant:"primary",size:"small",role:"button",disabled:x,onClick:async()=>await y(),children:t("actions.save")},"submit-button")]})})})]})]})]})]}),f.map(n=>e.jsx(ve,{item:n,orderId:s.id,currencyCode:s.currency_code},n.id)),a&&!f.length&&e.jsx("div",{style:{background:"repeating-linear-gradient(-45deg, rgb(212, 212, 216, 0.15), rgb(212, 212, 216,.15) 10px, transparent 10px, transparent 20px)"},className:"bg-ui-bg-field mt-4 block h-[56px] w-full rounded-lg border border-dashed"})]})},we=A.object({note:A.string().optional(),send_notification:A.boolean().optional()}),_e=({order:s,preview:l})=>{const{t}=v(),{handleSuccess:r}=pe(),{mutateAsync:a,isPending:u}=L(s.id),{mutateAsync:m,isPending:x}=B(s.id),y=u||x,f=ee({defaultValues:()=>Promise.resolve({note:"",send_notification:!1}),resolver:se(we)}),n=te(),w=f.handleSubmit(async j=>{try{if(!await n({title:t("general.areYouSure"),description:t("orders.edits.confirmText"),confirmText:t("actions.continue"),cancelText:t("actions.cancel"),variant:"confirmation"}))return;await m(),p.success(t("orders.edits.createSuccessToast")),r()}catch(c){p.error(t("general.error"),{description:c.message})}});return e.jsx(b.Form,{form:f,onClose:j=>{j||a(void 0,{onSuccess:()=>{p.success(t("orders.edits.cancelSuccessToast"))},onError:c=>{p.error(c.message)}})},children:e.jsxs(fe,{onSubmit:w,className:"flex h-full flex-col",children:[e.jsx(b.Header,{}),e.jsx(b.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(z,{level:"h1",children:t("orders.edits.create")}),e.jsx(Ne,{preview:l,order:s}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:t("orders.edits.currentTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:S(s.total,s.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:t("orders.edits.newTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:S(l.total,s.currency_code)})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:t("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:S(l.summary.pending_difference,s.currency_code)})]})]}),e.jsx(h.Field,{control:f.control,name:"note",render:({field:j})=>e.jsx(h.Item,{children:e.jsxs("div",{className:"mt-8 flex",children:[e.jsxs("div",{className:"block flex-1",children:[e.jsx(h.Label,{children:t("fields.note")}),e.jsx(h.Hint,{className:"!mt-1",children:t("orders.edits.noteHint")})]}),e.jsx("div",{className:"w-full flex-1 flex-grow",children:e.jsx(h.Control,{children:e.jsx(q,{...j,placeholder:t("fields.note")})})})]})})}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(h.Field,{control:f.control,name:"send_notification",render:({field:{onChange:j,value:c,...N}})=>e.jsxs(h.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h.Control,{className:"mr-4 self-start",children:e.jsx(ae,{className:"mt-[2px]",checked:!!c,onCheckedChange:j,...N})}),e.jsxs("div",{className:"block",children:[e.jsx(h.Label,{children:t("orders.returns.sendNotification")}),e.jsx(h.Hint,{className:"!mt-1",children:t("orders.returns.sendNotificationHint")})]})]}),e.jsx(h.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(b.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(b.Close,{asChild:!0,children:e.jsx(I,{type:"button",variant:"secondary",size:"small",children:t("orders.edits.cancel")})}),e.jsx(I,{type:"submit",variant:"primary",size:"small",isLoading:y,children:t("orders.edits.confirm")},"submit-button")]})})})]})})},P=!1,Je=()=>{const{id:s}=X(),l=Y(),{t}=v(),{order:r}=Z(s,{fields:G}),{order:a}=W(s),{mutateAsync:u}=H(r.id);return g.useEffect(()=>{async function m(){if(!(P||!a)){if(a.order_change){a.order_change.change_type!=="edit"&&(l(`/orders/${a.id}`,{replace:!0}),p.error(t("orders.edits.activeChangeError")));return}P=!0;try{const{order:x}=await u({order_id:a.id})}catch(x){p.error(x.message),l(`/orders/${a.id}`,{replace:!0})}finally{P=!1}}}m()},[a]),e.jsx(b,{children:a&&r&&e.jsx(_e,{order:r,preview:a})})};export{Je as Component};
