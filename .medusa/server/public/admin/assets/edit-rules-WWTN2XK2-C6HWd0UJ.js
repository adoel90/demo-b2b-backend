import{R as _}from"./chunk-Q7YRCENL-Cvn62g4l.js";import{$ as q,b as v,dq as E,j as r,H as S,dk as A,dr as C,ds as B,dt as k,r as z,aj as D,ak as H,an as s,B as R,aC as p}from"./index-BgVe_0kv.js";import"./chunk-GZBFGV7Y-DNMNassB.js";import{K as U}from"./chunk-6HTZNHPT-DYv5rdOA.js";import{b as c,u as $}from"./chunk-4TC5YS65-DXocPEx1.js";import"./chunk-HFB3OQXI-BlP5VKJQ.js";var K=s.object({type:s.string().optional(),rules:s.array(s.object({id:s.string().optional(),attribute:s.string().min(1,{message:p.t("promotions.form.required")}),operator:s.string().min(1,{message:p.t("promotions.form.required")}),values:s.union([s.number().min(1,{message:p.t("promotions.form.required")}),s.string().min(1,{message:p.t("promotions.form.required")}),s.array(s.string()).min(1,{message:p.t("promotions.form.required")})]),required:s.boolean().optional(),disguised:s.boolean().optional(),field_type:s.string().optional()}))}),L=({promotion:e,ruleType:f,handleSubmit:l,isSubmitting:i})=>{const{t:d}=v(),[n,a]=z.useState([]),u=D({defaultValues:{rules:[],type:e.type},resolver:H(K)}),m=u.handleSubmit(l(n));return r.jsx(c.Form,{form:u,children:r.jsxs(U,{onSubmit:m,className:"flex h-full flex-col",children:[r.jsx(c.Body,{children:r.jsx(_,{form:u,ruleType:f,setRulesToRemove:a,rulesToRemove:n,promotion:e})}),r.jsx(c.Footer,{children:r.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[r.jsx(c.Close,{asChild:!0,children:r.jsx(R,{size:"small",variant:"secondary",disabled:i,children:d("actions.cancel")})}),r.jsx(R,{size:"small",type:"submit",isLoading:i,children:d("actions.save")})]})})]})})},M=e=>e.field_type==="number"?parseInt(e.values):e.values,N=({promotion:e,rules:f,ruleType:l})=>{const{handleSuccess:i}=$(),{mutateAsync:d}=A(e.id),{mutateAsync:n}=C(e.id,l),{mutateAsync:a}=B(e.id,l),{mutateAsync:u,isPending:m}=k(e.id,l),b=o=>async function(g){const h={},{rules:x=[]}=g,w=x.filter(t=>t.disguised),F=(o==null?void 0:o.filter(t=>t.disguised))||[];for(const t of w)h[t.attribute]=M(t);for(const t of F)h[t.attribute]=null;const y=x.filter(t=>!t.disguised),j=y.filter(t=>!("id"in t)),P=y.filter(t=>typeof t.id=="string");Object.keys(h).length&&await d({application_method:h}),j.length&&await n({rules:j.map(t=>({attribute:t.attribute,operator:t.operator,values:t.values}))}),o!=null&&o.length&&await a({rule_ids:o.map(t=>t.id).filter(Boolean)}),P.length&&await u({rules:P.map(t=>({id:t.id,attribute:t.attribute,operator:t.operator,values:t.values}))}),i()};return r.jsx(L,{promotion:e,rules:f,ruleType:l,handleSubmit:b,isSubmitting:m})},Q=()=>{var o,g;const e=q();if(!["rules","buy-rules","target-rules"].includes(e.ruleType))throw"invalid page";const{t:l}=v(),i=e.ruleType,d=e.id,n=[],{promotion:a,isPending:u,isError:m,error:b}=E(d);if(a&&(i==="rules"?n.push(...a.rules||[]):i==="target-rules"?n.push(...((o=a==null?void 0:a.application_method)==null?void 0:o.target_rules)||[]):i==="buy-rules"&&n.push(...((g=a.application_method)==null?void 0:g.buy_rules)||[])),m)throw b;return r.jsxs(c,{children:[r.jsx(c.Header,{children:r.jsx(S,{children:l(`promotions.edit.${i}.title`)})}),!u&&a&&r.jsx(N,{promotion:a,rules:n,ruleType:i})]})};export{Q as Component};
